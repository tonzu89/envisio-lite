<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Помощник</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body class="bg-gray-100 h-screen flex flex-col">

    <div id="lobby-screen" class="p-4 flex-1 overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">С кем хотите поговорить?</h1>
            <a id="admin-btn" href="/admin" class="hidden bg-gray-800 text-white p-2 rounded-lg text-sm font-bold flex items-center gap-1 active:scale-95 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                </svg>
                Админ
            </a>
        </div>
        <div id="assistants-grid" class="grid grid-cols-2 gap-4">
        </div>
    </div>

    <div id="chat-screen" class="hidden flex flex-col h-full">
        <div class="bg-white p-4 shadow flex items-center">
            <button onclick="goBack()" class="text-blue-500 mr-4">← Назад</button>
            <span id="chat-title" class="font-bold text-lg">Чат</span>
        </div>
        <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
        
        <!-- Превью выбранного файла -->
        <div id="file-preview-container" class="hidden px-4 py-2 bg-white border-t flex items-center gap-2">
            <div class="relative">
                <img id="file-preview" src="" class="h-16 w-16 object-cover rounded-lg border">
                <button onclick="clearFile()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center">✕</button>
            </div>
            <span id="file-name" class="text-xs text-gray-500 truncate max-w-[150px]"></span>
        </div>

        <div class="p-4 bg-white border-t flex gap-2 items-center">
            <label for="file-upload" class="cursor-pointer text-gray-400 hover:text-blue-600 transition p-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                </svg>
            </label>
            <input id="file-upload" type="file" class="hidden" accept="image/*" onchange="previewFile()">
            
            <input type="text" id="msg-input" class="flex-1 border p-3 rounded-lg text-lg focus:outline-none focus:border-blue-500" placeholder="Напишите сообщение...">
            <button onclick="sendMessage()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold active:scale-95 transition">➤</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        let currentAssistant = null;
        let currentOffset = 0;
        let isLoadingHistory = false;
        let allHistoryLoaded = false;

        // --- ОБРАБОТЧИК ENTER ---
        document.getElementById('msg-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault(); // Предотвращаем стандартное поведение (если нужно)
                sendMessage();
            }
        });
        
        // Загрузка ассистентов
        async function loadAssistants() {
            try {
                // Проверка админа (для локальных тестов используем 12346, если нет ID от TG)
                const userId = tg.initDataUnsafe?.user?.id || 12346;
                if (userId) {
                    const adminRes = await fetch(`/api/is_admin?user_id=${userId}`);
                    const adminData = await adminRes.json();
                    if (adminData.is_admin) {
                        document.getElementById('admin-btn').classList.remove('hidden');
                    }
                }

                const res = await fetch('/api/assistants');
                const list = await res.json();
                const grid = document.getElementById('assistants-grid');
                
                list.forEach(ast => {
                    const btn = document.createElement('div');
                    btn.className = 'bg-white p-6 rounded-xl shadow-md text-center cursor-pointer active:scale-95 transition';
                    btn.innerHTML = `<div class="text-4xl mb-2">${ast.icon_emoji}</div><div class="font-bold text-lg">${ast.name}</div><div class="text-gray-500 text-sm">${ast.description}</div>`;
                    btn.onclick = () => openChat(ast);
                    grid.appendChild(btn);
                });
            } catch (e) {
                console.error("Ошибка загрузки ассистентов", e);
            }
        }

        function openChat(ast) {
            currentAssistant = ast;
            document.getElementById('lobby-screen').classList.add('hidden');
            document.getElementById('chat-screen').classList.remove('hidden');
            document.getElementById('chat-screen').classList.add('flex');
            document.getElementById('chat-title').innerText = ast.name;
            document.getElementById('messages').innerHTML = '';
            
            // Сброс состояния истории
            currentOffset = 0;
            allHistoryLoaded = false;
            loadHistory();
        }

        // Бесконечный скролл (Lazy Loading)
        document.getElementById('messages').addEventListener('scroll', function() {
            if (this.scrollTop === 0 && !isLoadingHistory && !allHistoryLoaded) {
                loadHistory();
            }
        });

        async function loadHistory() {
            if (isLoadingHistory || allHistoryLoaded) return;
            isLoadingHistory = true;

            const limit = 20;
            try {
                const res = await fetch(`/api/history?assistant_slug=${currentAssistant.slug}&offset=${currentOffset}&limit=${limit}`, {
                     headers: {
                        'X-Telegram-Init-Data': tg.initData
                    }
                });
                const messages = await res.json();

                if (messages.length < limit) {
                    allHistoryLoaded = true;
                }

                if (messages.length > 0) {
                    const container = document.getElementById('messages');
                    const oldHeight = container.scrollHeight;

                    if (currentOffset === 0) {
                        // Первая загрузка: добавляем в хронологическом порядке (Старые -> Новые)
                        // API отдает Новые -> Старые, поэтому реверсим
                        messages.reverse().forEach(msg => {
                            container.appendChild(createMessageElement(msg.content, msg.role, null, msg.image_path));
                        });
                        // Скролл вниз
                        container.scrollTo(0, container.scrollHeight);
                    } else {
                        // Подгрузка истории: добавляем вверх
                        messages.forEach(msg => {
                            container.prepend(createMessageElement(msg.content, msg.role, null, msg.image_path));
                        });
                        
                        // Восстанавливаем позицию скролла
                        container.scrollTop = container.scrollHeight - oldHeight;
                    }

                    currentOffset += messages.length;
                } else if (currentOffset === 0 && currentAssistant.welcome_message) {
                    // Если истории нет (первый запуск), показываем приветственное сообщение
                    const container = document.getElementById('messages');
                    container.appendChild(createMessageElement(currentAssistant.welcome_message, 'ai'));
                }
            } catch (e) {
                console.error("Error loading history", e);
            } finally {
                isLoadingHistory = false;
            }
        }

        function goBack() {
            document.getElementById('chat-screen').classList.add('hidden');
            document.getElementById('chat-screen').classList.remove('flex');
            document.getElementById('lobby-screen').classList.remove('hidden');
        }

        // --- VISION FUNCTIONS ---
        function previewFile() {
            const fileInput = document.getElementById('file-upload');
            const file = fileInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('file-preview').src = e.target.result;
                    document.getElementById('file-preview-container').classList.remove('hidden');
                    document.getElementById('file-name').innerText = file.name;
                }
                reader.readAsDataURL(file);
            }
        }

        function clearFile() {
            const fileInput = document.getElementById('file-upload');
            fileInput.value = '';
            document.getElementById('file-preview-container').classList.add('hidden');
        }

        // Показывает индикатор набора текста
        function showTyping() {
            // Если уже есть индикатор — не создаем новый
            if (document.getElementById('typing-indicator')) return;

            const div = document.createElement('div');
            div.id = 'typing-indicator';
            // Стили такие же, как у сообщения ассистента, но текст серый и курсив
            div.className = 'bg-white border border-gray-200 self-start mr-12 rounded-t-2xl rounded-br-2xl rounded-bl-none p-4 shadow-sm text-gray-400 italic animate-pulse';
            div.innerText = 'Печатает...';

            const container = document.getElementById('messages');
            container.appendChild(div);
            container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
        }

        // Удаляет индикатор
        function hideTyping() {
            const el = document.getElementById('typing-indicator');
            if (el) el.remove();
        }
        async function sendMessage() {
            const input = document.getElementById('msg-input');
            const fileInput = document.getElementById('file-upload');
            const text = input.value.trim();
            const file = fileInput.files[0];

            if (!text && !file) return;

            // 1. Показываем сообщение юзера
            addMessage(text, 'user', file);
            input.value = '';
            clearFile();

            // 2. ВКЛЮЧАЕМ "ПЕЧАТАЕТ..."
            showTyping();

            try {
                const formData = new FormData();
                formData.append('assistant_slug', currentAssistant.slug);
                formData.append('text', text);
                if (file) {
                    formData.append('file', file);
                }

                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'X-Telegram-Init-Data': tg.initData 
                    },
                    body: formData
                });

                // 3. ВЫКЛЮЧАЕМ "ПЕЧАТАЕТ..." (ответ пришел)
                hideTyping();

                if (res.status === 403) {
                    addMessage("⚠️ Ошибка: Запустите через Telegram", 'ai');
                    return;
                }

                const data = await res.json();
                addMessage(data.response, 'ai');
            } catch (e) {
                // Если ошибка сети — тоже убираем индикатор
                hideTyping();
                addMessage("⚠️ Ошибка сети", 'ai');
            }
        }

        function createMessageElement(text, role, file = null, image_path = null) {
            const div = document.createElement('div');
            
            // Базовые стили
            let bubbleClass = role === 'user'
                ? 'bg-blue-100 self-end ml-auto'
                : 'bg-white border self-start';
            
            div.className = `${bubbleClass} p-3 rounded-lg max-w-[90%] text-lg prose prose-p:my-1 prose-a:text-blue-600 prose-a:underline break-words leading-snug`;

            // Если есть текст, парсим Markdown
            if (text) {
                div.innerHTML = marked.parse(text);
            }

            // Если есть image_path (из истории)
            if (image_path) {
                const img = document.createElement('img');
                img.src = '/' + image_path;
                img.className = 'max-w-full rounded-lg mt-2 border';
                div.appendChild(img);
            }

            // Если есть файл (только что отправленный), добавляем превью
            if (file) {
                const img = document.createElement('img');
                img.className = 'max-w-full rounded-lg mt-2 border';
                const reader = new FileReader();
                reader.onload = (e) => { 
                    img.src = e.target.result;
                    // Прокрутка после загрузки картинки
                    document.getElementById('messages').scrollTo(0, document.getElementById('messages').scrollHeight);
                };
                reader.readAsDataURL(file);
                div.appendChild(img);
            }

            // Заставляем ссылки открываться во внешнем браузере
            const links = div.querySelectorAll('a');
            links.forEach(link => {
                link.target = '_blank';
            });
            return div;
        }

        function addMessage(text, role, file = null) {
            const div = createMessageElement(text, role, file);
            document.getElementById('messages').appendChild(div);
            // Прокрутка вниз
            document.getElementById('messages').scrollTo(0, document.getElementById('messages').scrollHeight);
        }

        loadAssistants();
    </script>
</body>
</html>